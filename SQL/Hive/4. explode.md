# explode

## 背景

在 hive 表中，有些字段虽然是 string 类型，但存储了一个数组。

举个例子，表`test_table`中的`cities`字段是 string 类型，但是实际上存储了以逗号分隔的城市 ID 列表：

```sql
select
 id
 ,cities
from test_table
limit 5;
```

查询结果：

| #    | id   | cities                                                |
| ---- | ---- | ----------------------------------------------------- |
| 1    | 232  | 55000515                                              |
| 2    | 576  | 52140500,52310300,52080800,52110500,52220400,52170200 |
| 3    | 1107 | 55000116                                              |
| 4    | 2221 | 55000185,55000353                                     |
| 5    | 3623 | 55000182,55000409,55000515                            |

## 问题

现在我们需要将`cities`字段信息拆分开来，方便按照`city_id`和其他表进行 join。

## 解决方法

首先按照使用`split()`按照逗号分隔符将`cities`字段拆分成数组：

```sql
select
 id
 ,split(cities, ",") as city_list
from test_table
limit 5;
```

| #    | id   | city_list                                               |
| ---- | ---- | ------------------------------------------------------- |
| 1    | 232  | [55000515]                                              |
| 2    | 576  | [52140500,52310300,52080800,52110500,52220400,52170200] |
| 3    | 1107 | [55000116]                                              |
| 4    | 2221 | [55000185,55000353]                                     |
| 5    | 3623 | [55000182,55000409,55000515]                            |

然后再使用`explode()`对`city_list`数组进行展开：

```sql
select
 explode(city_list) as city_id
from
(
    select
        id
        ,split(cities, ",") as city_list
    from test_table
    limit 5
) t
```

| #    | city_id  |
| ---- | :------- |
| 1    | 55000515 |
| 2    | 52140500 |
| 3    | 52310300 |
| 4    | 52080800 |
| 5    | 52110500 |
| 6    | 52220400 |
| 7    | 52170200 |
| 8    | 55000116 |
| 9    | 55000185 |
| 10   | 55000353 |
| 11   | 55000182 |
| 12   | 55000409 |
| 13   | 55000515 |

## 注意事项

当使用 UDTF 函数时，hive 只允许对拆分字段进行访问：

```sql
-- 正确写法
select explode(city_list) from test_table;

-- 错误写法
select id, explode(city_list) from test_table;
```

如果我们想访问除了拆分字段以外的字段时（比如上述例子中的`id`字段），需要使用`lateral view`侧视图：

```sql
select
 id
 ,city_id
from
(
    select
     id
     ,split(cities, ",") as city_list
    from test_table
    limit 5
) t lateral view explode(city_list) t2 as city_id
```

| #    | id   | city_id  |
| ---- | ---- | :------- |
| 1    | 232  | 55000515 |
| 2    | 576  | 52140500 |
| 3    | 576  | 52310300 |
| 4    | 576  | 52080800 |
| 5    | 576  | 52110500 |
| 6    | 576  | 52220400 |
| 7    | 576  | 52170200 |
| 8    | 1107 | 55000116 |
| 9    | 2221 | 55000185 |
| 10   | 2221 | 55000353 |
| 11   | 3623 | 55000182 |
| 12   | 3623 | 55000409 |
| 13   | 3623 | 55000515 |

## Reference

[1] <https://blog.csdn.net/u011110301/article/details/104198588>
