# cookies 机制和 session 机制

## 总结

* cookies 机制保存在客户端，session 机制保存在服务端
* **cookies 可以减轻服务器压力，但是不安全**，容易进行 cookies 欺骗
* session 安全一点，占用服务器资源
* Session 随会话结束而关闭，Cookie 可以长期保存在客户端硬盘上，也可以临时保存在浏览器内存中
* Session 用来保存重要信息，Cookie 用来保存不重要的用户信息

## **为什么有 Session 和 Cookie**

根据早期的 HTTP 协议，每次 request-reponse 时，都要重新建立 TCP 连接。TCP 连接每次都重新建立，**所以服务器无法知道上次请求和本次请求是否来自于同一个客户端。因此，HTTP 通信是无状态的。服务器认为每次请求都是一个全新的请求，无论该请求是否来自同一地址。**

假如不使用 Session 或 Cookie，那么就意味着假如你登录了某个购物网站，**你的每次请求因为无状态，购物网站的服务器都无法判断你的身份和登陆与否**，意味着为了保持登陆你必须浏览某个商品时登陆一次，浏览另一个商品又要登陆一次。

这种用户体验谁还愿意上购物网站？于是出现了 Cookie，它把少量的用户信息存储在用户自己电脑上，因为它在同一个域名下是全局的，**所以用户访问时，服务器就可以从该域名下任意页面读取 Cookie 中的信息，以判断登陆状态**。

**但 Cookie 存在用户端，存储尺寸也有大小限制，用户自身还可以禁用，甚至可见并修改，安全性极差**。**为了安全，又能方便地读取全局信息，于是出现了新的存储会话机制，Session**。·cookies 机制

cookies 是小型文本文件，**是某些网站为了辨别用户身份进行 Session 跟踪而存储在用户本地终端上的数据（通常经过加密）**。

简而言之，cookies 是一个记录你身份的文本文件，假如你访问了我的网站，你的电脑里就会储存你这次访问的 cookie 信息，如果你在一段时间之内再次访问我的网站，**我的服务器就可以分辨出两次访问的用户是同一个**。

### 1. 好处

以知乎为例，你第一次访问并登录知乎网站后，因为服务器保存了你的 cookie 信息，所以你在 cookie 有效期内就可以保持登录状态，不用每次访问都输入一次账号密码，这样来看还是很方便的。

### 2. 坏处

再以知乎为例，你看了这个问题又浏览了另一个问题，通过 cookie 知乎就可以知道这两次访问是一个人，**然后就可以分析你的行为，给你推荐你更可能喜欢的内容**。

比如你在谷歌的 gmail 登录了邮箱，又用谷歌搜索搜索了东西，谷歌就可以通过 cookie 知道这些搜索请求是哪个 gmail 用户发出的，如果谷歌收集了这些数据又不小心泄露了，你想想会怎样？

另外，通过 cookies 可以爬虫。

## session 机制

有了 Session，**就能让用户在一次会话中的多次 HTTP 请求产生关联**，让多个页面都能读取到 Session 域里面的值。Session 信息存放在服务器端，也很好地解决了安全问题。

但是同样有疑问，若干客户端和服务器连接，服务器会为每个客户端的一次会话创建一个会话对象 Session，如何区分哪个 Session 对应的是哪个客户端呢？

答案是，**多数容器是采用 Cookie 机制来实现 Session 机制**，也就是说，利用 Cookie 来保存 “客户端” 和 “服务器里会话对象” 之间的对应关系。

## Cookies 实现 session 机制

* 当容器创建一个新的 HttpSession 对象后，**会生成一个随机数，称之为会话 ID**，并将 ID 值封装成一个名为 JSESSIONID 的 Cookie，返回给客户端；
* 之后的请求，在调用 request.getSession 方法获得会话对象时，容器会先从 request 中获取 JSESSIONID 的值，根据值查找到对应的会话对象，返回使用
* 如果没有获得 JSESSIONID 值，则容器认为当前请求没有相关联的会话对象，会重复第一步进行生成。
