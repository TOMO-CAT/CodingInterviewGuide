# 分单可视化及决策平台

## 设计

### 1. 数据库

* MySQL：存储一些配置和元数据信息，例如某页有哪些图表等
* Clickhouse：只能查询无法修改，存储 `city-product` 级别的天级增量表
* Hive：建立同步任务，定时同步到 MySQL 和 Clickhouse

### 2. 接口

* 可视化报表接口（支持最常见的直方图、折线图、漏斗图及其定制化功能）：
  * 数据集的增删改查
  * 指标的增删改查
* 格式化文本渲染：提供文本，查完数据并返回渲染结果
* 引擎内部策略及功能展示：
  * 功能包括：顺路单、连环单、顺路单、应答后改派等
  * 策略包括：新司机倾斜、短单 hold、动态播单半径等
  * Markdown 介绍对应的策略
  * 提供关键指标的可视化报表
  * 提供阈值调整后的预测

## 功能

### 1. 模块化数据报表配置

* 数据集表：
  * `id`：数据集 ID
  * `sql`：数据集查询 SQL
  * `dimension`：原始列
  * `output_col`：导出列
* 页面表：
  * `id`：页面 ID
  * `report_id`：报表 ID
  * `comment`：页面注释等
* 报表表：
  * `id`：报表 ID
  * `name`：报表名字
  * `comment`：报表注释
  * `data_set`：报表依赖的数据集
  * `condition`：查询条件，包括 where 子句、condition 子句和 dimension 展示纬度
* 导出列计算公式表
  * `id`：导出列 ID
  * `name`：导出列名称
  * `expr`：导出列计算公式

### 2. 智能诊断与策略推荐

> adsr：供需比，就是司机在线小时数/订单数

功能：

* 供需诊断：根据地理格子计算供需的时间和空间失衡问题（不同 adsr 的格子数量，分成高 dsr、低 dsr 和中 dsr），根据不同的供需失衡推荐不同引擎策略（主要是促进发单的抓手和促进司机出车的抓手）
* 策略分析：对于每一个策略，给出是否建议开启策略的分析，以及策略的参数（下面以新司机倾斜为例）
  * 是否开启策略：新司机占比，新司机周留存、月留存，抢单/完单率指标和司机体验等指标
  * 策略参数：新司机定义参数（播单数、完单数、首次完单距今天数）、优质订单定义（接驾距离、订单里程、预测 DAR）、调层还是调权

## 优化

### 1. MySQL 元信息热更新

有很多数据是反复查询，但是更新频率又很低的。服务启动后先从 MySQL 加载，然后定时刷新。

### 2. 存储引擎从 MySQL 到 clickhouse

clickhouse 使用速度更快。

### 3. orm

使用 orm 优化代码逻辑和提供给前端的接口参数。
