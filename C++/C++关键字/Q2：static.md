# static

## 初始化时机

* 类的静态成员：在类实例化前初始化
* 函数的静态变量：在执行此函数时初始化

## 用途

当我们在 C/C++用 static 修饰变量或函数时，主要有三种用途：

* 局部静态变量
* 外部静态变量/函数（废弃，C++标准用匿名命名空间替代）
* 类内静态数据成员/成员函数（只存在于 C++中）

## 局部静态变量

### 1. 简介

在局部变量前面加上 static 说明符就构成静态局部变量，例如：

```c++
// 声明局部静态变量
static int a;
static int array[5] = {1, 2, 3, 4, 5};
```

### 2. 特点

* 静态局部变量在函数内定义，但不像自动变量那样当函数被调用时就存在，调用结束就消失，静态变量的生存期为整个源程序
* 静态变量的生存期虽然为整个源程序，但是作用域与自动变量相同，即只能在定义该变量的函数内使用该变量，退出函数后虽然变量还存在，但不能够使用它
* 对基本类型的静态局部变量如果在声明时未赋初始值，则系统自动赋 0 值（因为它存储在 BSS 段）；而对普通局部变量不赋初始值，那么它的值是不确定的

### 3. 用途

根据静态局部变量的特点，它的生存期为整个源程序，在离开定义它的函数（作用域）但再次调用定义它的函数时，它又可继续使用，而且保存了前次被调用后留下的值。因此，当多次调用一个函数且要求在调用之间保留某些变量的值时，可考虑采用静态局部变量，虽然用全局变量也可以达到上述目的，但全局变量有时会造成意外的副作用，因此最好采用局部静态变量。例如：

```c++
#include <iostream>

void foo() {
    int j = 0;         // 普通局部变量
    static int k = 0;  // 静态局部变量
    ++j;
    ++k;
    printf("j:%d, k:%d\n", j, k);
}

int main(void)
{
    for (int i = 1; i <= 5; i++) {
        foo();
    }
}

// 输出:
j:1, k:1
j:1, k:2
j:1, k:3
j:1, k:4
j:1, k:5
```

## 静态全局变量（C++废弃，使用匿名空间替代）

> Tips：对于全局变量，不管是否被 static 修饰，它的存储区域都是在静态存储区，生存期为整个源程序。只不过加上 static 后限制这个全局变量的作用域只能在定义该变量的源文件内。

### 1. 简介

全局变量（外部变量）的声明之前加上 static 就构成了静态的全局变量，全局变量本身就是静态存储变量，静态全局变量当然也是静态存储方式。这两者在存储方式上并无不同，这两者的区别在于**非静态全局变量的作用域是整个源程序**。当一个源程序由多个源程序组成时，非静态的全局变量在各个源文件中都是有效的，而静态全局变量则限制了其作用域，即只在定义该变量的源文件内有效，在同一源程序的其他源文件中不能使用它。

这种在文件中进行静态声明的做法是从 C 语言继承而来的，在 C 语言中声明为 static 的全局变量在其所在的文件外不可见。这种做法已经被 C++标准取消了，现在的替代做法是使用匿名命名空间。

### 2. 匿名命名空间

匿名命名空间指的是关键字 namespace 后紧跟花括号括起来的一系列声明语句，具有如下特点：

* 在匿名命名空间内定义的变量具有静态生命周期
* 匿名空间在某个给定的文件内可以不连续，但是不能跨越多个文件
* 每个文件定义自己的匿名命名空间，不同文件匿名命名空间中定义的名字对应不同实体
* 如果在一个头文件中定义了匿名命名空间，则该命名空间内定义的名字在每个包含该头文件的文件中对应不同实体

```c++
namespace {
    int i;  // 匿名命名空间内定义的变量具有静态生命周期, 作用域仅限于当前文件
}
```

## 静态全局函数（C++废弃，使用匿名空间替代）

静态全局函数和普通函数不同，它只能在声明它的文件中可见，不能被其他文件使用。同静态全局变量一样，在 C++中我们最好使用匿名空间实现该功能。

## 类静态成员

类静态成员包括静态数据成员与静态成员函数，它们与类本身直接相关，而不是与类的各个对象保持关联：

### 1. 类静态数据成员

在编译时创建并初始化，在该类的任何对象创建之前就存在，不属于任何对象。

### 2. 类静态成员函数

* 类静态成员函数属于整个类，由该类所有对象共享
* 不包含 this 指针
* 无法访问类对象的非静态数据成员和非静态成员函数，只能访问静态数据成员和调用静态成员函数

## Reference

[1] <https://zhuanlan.zhihu.com/p/59097334>

[2] <https://www.cnblogs.com/renyuan/archive/2012/11/30/2796801.html>
